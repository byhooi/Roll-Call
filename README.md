# 班级点名系统

基于浏览器的教学辅助工具，提供公平随机点名、学生名单管理与统计分析功能，适合课堂投影或教师自用。

## 功能特性

### 🎯 公平点名算法
- 优先选择当前周期内被点名次数最少的学生群组
- 从候选群组中随机抽取，确保每位学生机会均等
- 实时更新点名次数和最后点名时间
- 支持空格键快捷点名，提升课堂操作效率

### 📋 学生名单管理
- **Excel 导入**：支持 `.xlsx` 和 `.xls` 格式，自动识别"姓名"和"座位号"列
- **数据验证**：导入时自动检测重复座位号、重复姓名、姓名长度等问题
- **手动添加**：通过弹窗表单添加单个学生，含实时输入验证
- **安全删除**：删除学生前显示详细信息确认，防止误操作
- **批量清空**：二次确认机制保护数据安全

### 📊 统计分析
- **实时统计**：总点名次数、学生总数、平均被点次数
- **详细报表**：每位学生的点名次数、最后点名时间
- **点名分布**：直观展示点名次数分布情况
- **周期管理**：支持重置统计周期，开始新一轮统计

### 💾 数据持久化
- **本地存储**：所有数据保存在浏览器 LocalStorage，无需联网
- **自动备份**：每 5 分钟自动备份一次数据
- **手动备份**：支持导出 Excel 报表和 JSON 数据备份
- **数据恢复**：导入失败时自动回滚，保护原有数据

### 🎨 用户体验
- **响应式设计**：支持桌面端和移动端访问
- **Toast 通知**：成功/错误/信息三种提示，友好的用户反馈
- **加载状态**：Excel 导入时显示加载动画和进度提示
- **快捷键支持**：空格键点名、ESC 键关闭弹窗
- **表单验证**：实时验证输入，边框颜色提示有效性

## 快速开始

### 安装与运行

**方式 1：直接打开（推荐）**
```bash
# 双击 index.html 文件即可在浏览器中打开
```

**方式 2：本地服务器**
```bash
# Python 3
python -m http.server 8000

# 然后在浏览器访问 http://localhost:8000
```

### 基本使用流程

#### 1. 导入学生名单

在"学生管理"标签页点击"导入学生名单"按钮，选择 Excel 文件。

**Excel 文件格式要求：**

| 座位号 | 姓名 |
| ------ | ---- |
| 1      | 张三 |
| 2      | 李四 |
| 3      | 王五 |

- 表头必须包含"座位号"和"姓名"关键字（不区分大小写）
- 座位号必须为正整数（1-100 推荐范围）
- 姓名建议不超过 20 个字符
- 系统会自动检测并提示重复或异常数据

#### 2. 开始点名

切换到"点名"标签页，点击"开始点名"按钮或按下**空格键**即可随机抽取学生。

被选中的学生会以大字显示，同时显示其本周期内的被点次数。

#### 3. 查看统计

在"统计分析"标签页查看：
- 总点名次数、学生总数、平均被点次数
- 每位学生的详细点名记录
- 支持导出统计报表（Excel 格式）

#### 4. 数据管理

**重置统计周期**：清零所有学生的被点名次数，开始新一轮统计

**导出数据**：
- 导出学生名单（含被点次数和最后点名时间）
- 导出统计报表（包含汇总信息和详情两个工作表）

**清空数据**：删除所有学生信息、点名历史和统计数据（需二次确认）

## 技术架构

### 技术栈
- **前端框架**：原生 HTML、CSS、JavaScript（ES6+）
- **数据存储**：浏览器 LocalStorage
- **Excel 处理**：SheetJS (xlsx.js) 通过 CDN 引入
- **无后端依赖**：纯前端实现，离线可用

### 模块设计

```
js/
├── app.js          # UI 交互层 (RollCallApp + NotificationSystem)
├── storage.js      # 数据持久层 (StorageManager)
├── algorithm.js    # 业务逻辑层 (RollCallAlgorithm)
└── excel.js        # 工具层 (ExcelManager)
```

**核心类职责：**

- **RollCallApp**：管理所有 UI 交互、事件监听、页面状态
- **StorageManager**：封装 LocalStorage 操作、内存索引、自动备份
- **RollCallAlgorithm**：实现公平随机点名算法、统计计算
- **ExcelManager**：处理 Excel 文件导入导出、数据验证
- **NotificationSystem**：Toast 通知系统

### 核心算法

**公平随机点名算法：**

1. 获取所有学生的 `callCount`（本周期被点名次数）
2. 找出 `callCount` 最小的学生群组（可能多人并列）
3. 从该群组中使用 `Math.random()` 随机选择一位学生
4. 更新该学生的 `callCount++` 和 `lastCall` 时间戳
5. 添加点名记录到历史记录中

**示例：**
- 学生 A：被点 3 次
- 学生 B：被点 3 次
- 学生 C：被点 5 次

算法会从 A 和 B 中随机选一个（因为他们被点次数最少）。

### 数据结构

**LocalStorage 存储键：**
- `roll-call-data`：主数据（学生、历史记录、统计信息）
- `roll-call-backup`：自动备份数据

**学生对象：**
```javascript
{
  id: "lx1y2z3abc456def",           // 唯一ID（36进制时间戳+随机数+计数器）
  name: "张三",                      // 学生姓名
  seat: 1,                           // 座位号
  callCount: 5,                      // 本周期被点名次数
  lastCall: "2025-01-15T10:30:00.000Z"  // 最后点名时间（ISO格式）
}
```

**点名记录：**
```javascript
{
  id: "lx1y2z3ghi789jkl",           // 记录ID
  studentId: "lx1y2z3abc456def",    // 学生ID
  studentName: "张三",               // 学生姓名（冗余存储）
  studentSeat: 1,                    // 座位号（冗余存储）
  timestamp: "2025-01-15T10:30:00.000Z",  // 点名时间戳
  date: "2025/1/15"                  // 点名日期（本地格式）
}
```

## 数据备份与恢复

### 自动备份
- 系统每 5 分钟自动在 LocalStorage 中创建备份
- 备份键：`roll-call-backup`
- 存储空间不足时自动暂停备份并清理旧备份
- 控制台会输出备份状态日志

### 手动备份
通过"导出统计报表"功能导出 Excel 文件，包含：
- 学生名单（座位号、姓名、被点次数、最后点名时间）
- 汇总信息（统计周期、总次数、平均次数、分布情况）

### 数据恢复
在浏览器控制台执行：
```javascript
// 查看备份信息
storage.getBackupInfo()

// 恢复备份
storage.restoreAutoBackup()

// 查看完整数据
storage.getAllData()
```

## 浏览器兼容性

- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ 移动端浏览器（iOS Safari、Chrome Mobile）

**注意事项：**
- 浏览器隐私模式（无痕浏览）下，LocalStorage 会在关闭标签时清空
- 多标签页同时操作可能导致数据不一致，建议仅在一个标签页使用
- LocalStorage 容量限制通常为 5-10MB

## 常见问题

### Q: 导入 Excel 时提示"缺少必要的表头"？
A: 确保 Excel 文件第一行包含"座位号"和"姓名"��段（不区分大小写）。表头可以是"座位号""座位"或包含这些关键字的任意文本。

### Q: 如何备份数据？
A: 有两种方式：
1. 自动备份每 5 分钟运行一次，保存在浏览器本地
2. 手动导出 Excel 报表，可永久保存到电脑

### Q: 清空浏览器缓存会丢失数据吗？
A: 是的，清空浏览器数据会删除 LocalStorage，建议定期导出 Excel 备份。

### Q: 可以在多台电脑使用吗？
A: 数据仅存储在本地浏览器，不同电脑间不会同步。可以通过导入导出 Excel 在多台电脑间迁移数据。

### Q: 点名算法真的公平吗？
A: 是的，算法确保被点名次数少的学生优先被选中，在次数相同的情况下完全随机，长期使用会趋于均匀分布。

### Q: 系统支持多个班级吗？
A: 当前版本为单班级设计，如需多班级可以：
1. 使用不同浏览器或浏览器配置文件
2. 定期导出当前班级数据，清空后导入新班级

## 开发与调试

### 项目结构
```
Roll Call/
├── index.html       # 主页面（包含内联样式）
├── css/
│   └── style.css   # 全局样式
└── js/
    ├── app.js      # UI交互层
    ├── storage.js  # 数据持久层
    ├── algorithm.js # 业务逻辑层
    └── excel.js    # 工具层
```

### 调试命令
在浏览器控制台执行以下命令：

```javascript
// 查看完整数据
storage.getAllData()

// 查看所有学生
storage.getStudents()

// 查看点名历史
storage.getCallHistory()

// 查看统计信息
algorithm.getStudentStats()

// 预览下次可能被点到的学生
algorithm.previewNextCall()

// 查看备份状态
storage.getBackupInfo()

// 恢复备份
storage.restoreAutoBackup()
```

### 修改建议
- 修改点名算法：编辑 `js/algorithm.js` 中的 `getLeastCalledGroup()` 方法
- 修改数据结构：编辑 `js/storage.js` 中的 `createDefaultData()` 方法
- 修改 UI 样式：编辑 `css/style.css` 或 `index.html` 中的内联样式
- 添加新功能：按照"数据层 → 逻辑层 → UI层"的顺序修改

## 许可证

本项目遵循 MIT License，仅供教学场景使用。

---

## 更新日志

### v1.0.0 (2025-01)
- ✨ 公平随机点名算法
- ✨ Excel 导入导出功能
- ✨ 统计分析面板
- ✨ 自动备份机制
- ✨ 数据验证与回滚
- ✨ Toast 通知系统
- ✨ 快捷键支持（空格键点名、ESC关闭弹窗）
- ✨ 表单实时验证
- ✨ 内存索引优化

## 贡献

欢迎提交 Issue 和 Pull Request！

如需帮助或有建议，请创建 Issue 描述您的需求。
